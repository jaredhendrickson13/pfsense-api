import e2e_test_framework


class APIE2ETestSystemCertificate(e2e_test_framework.APIE2ETest):
    crt = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR5VENDQXJHZ0F3SUJBZ0lVZUZacVZwcXlDNXRqa0I2TWNwdnIybGlHRDc0d0RRWUpLb1pJaHZjTkFRRUwKQlFBd2N6RUxNQWtHQTFVRUJoTUNWVk14RFRBTEJnTlZCQWdNQkZWMFlXZ3hEakFNQmdOVkJBY01CVkJ5YjNadgpNUnN3R1FZRFZRUUtEQkpxWVhKbFpHaGxibVJ5YVdOcmMyOXVNVE14RWpBUUJnTlZCQXNNQ1VSbGRtVnNiM0JsCmNqRVVNQklHQTFVRUF3d0xjR1p6Wlc1elpTMWhjR2t3SUJjTk1qQXdPVEk0TVRnek1EQXlXaGdQTXpBeU1EQXgKTXpBeE9ETXdNREphTUhNeEN6QUpCZ05WQkFZVEFsVlRNUTB3Q3dZRFZRUUlEQVJWZEdGb01RNHdEQVlEVlFRSApEQVZRY205MmJ6RWJNQmtHQTFVRUNnd1NhbUZ5WldSb1pXNWtjbWxqYTNOdmJqRXpNUkl3RUFZRFZRUUxEQWxFClpYWmxiRzl3WlhJeEZEQVNCZ05WQkFNTUMzQm1jMlZ1YzJVdFlYQnBNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUYKQUFPQ0FROEFNSUlCQ2dLQ0FRRUFvQ2x3d1Jzajg4Tnk0Z1Zid2NhRUYzU0s4SlQvZEowQUxjV1F4Wnh1WUt3MgpHMldCK0Y3RWZBbTNVN21qNEt0bWF0ZEhEWVppZ1c0T0dzSWE0dVZKaGhVWDJ0RlMvcGQ2UHlFa2ZyMHFvcm1nCm84MnNJUW9WZS84YTRVRzJYeXl1SkROVks2SjJJS1hodUt2dEpCVk5xZlJoZExVNDNHLzAxZjBnTkwrSlE4VDMKVlpCUFgyZXpMK1hNUGg2ZkFpRG5MNmp2c0F3ZTZ4cEhEYTVDL0l1VmJ6Z2V6YUNiREFneVcvZFowcDltNzNPNApBWnV3UXVwUUNTUkZWenJnS3dyaUF0SDhnVGRtVWtKdG10a2hwL0R3bTRha2k3dmpsYTI0R0JsZXVlQzJ6azhZCkhMMGxERENBeWtsM2o5UEpUM0ttbC9LVzFkQ3FvcTZTWmYxNTRZZzlEd0lEQVFBQm8xTXdVVEFkQmdOVkhRNEUKRmdRVU5veC9UdE45SWxLMlA3YjF1ZzJ1dHJ2ZGtXY3dId1lEVlIwakJCZ3dGb0FVTm94L1R0TjlJbEsyUDdiMQp1ZzJ1dHJ2ZGtXY3dEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFhT2xsCmMrbDRHTXZjNDBKUnlGRDdoeUJlSkVsN0x5NmVpeFpxNUdzU0hpbEJiT2M5MmQ3b1dja3ptZGNIT0hqdlRwU3kKTXpOclVqcGFoMlZDSXZXMXhXaHEwMWJMQnJwRmtqNmNwbkY3d2NTVnlSODdSOG4za0x2dlRqMEhoVE9rb1FRVwp2VGVTei9RaytFVm9SeHdob3J5U2VnWW9yQTRScUZyd2c1a3puZGVrM0gwSXcyQzkxZVBUbjRmSU5mTkpUTnhHCmc3eDhxWCtySFl4L0R2Y0hjSVEzYVlzYVJ1TXNTYmtHYjdwUXZmOXNneE1weC9ucU8xS0RKVUUrOTVRQTJOa3oKTldYeDFaeVVVcUNOd0RVVENaczNzczVYSWJrdTJSWXhmNWxMTG03YnQrUHZwY3RVOVRSUzlmQWUvQXpldjI3KwpTQzM2Nm1uYnh0OG5xVnR1K0E9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="
    key = "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ2dLWERCR3lQenczTGkKQlZ2QnhvUVhkSXJ3bFA5MG5RQXR4WkRGbkc1Z3JEWWJaWUg0WHNSOENiZFR1YVBncTJacTEwY05obUtCYmc0YQp3aHJpNVVtR0ZSZmEwVkwrbDNvL0lTUit2U3FpdWFDanphd2hDaFY3L3hyaFFiWmZMSzRrTTFVcm9uWWdwZUc0CnErMGtGVTJwOUdGMHRUamNiL1RWL1NBMHY0bER4UGRWa0U5Zlo3TXY1Y3crSHA4Q0lPY3ZxTyt3REI3ckdrY04KcmtMOGk1VnZPQjdOb0pzTUNESmI5MW5TbjJidmM3Z0JtN0JDNmxBSkpFVlhPdUFyQ3VJQzBmeUJOMlpTUW0yYQoyU0duOFBDYmhxU0x1K09WcmJnWUdWNjU0TGJPVHhnY3ZTVU1NSURLU1hlUDA4bFBjcWFYOHBiVjBLcWlycEpsCi9YbmhpRDBQQWdNQkFBRUNnZ0VBRlpCKzFnRkpmZkM2N3lPNWp3V2prMlRsc0M3ZmxsdnRRanh2bWF2T1VNWGYKSXlFdnRybEx5MGVqbjJwSFhtQzFrWDBhMi85VUZBazFiUFRsbWRjMVp4QS8vZjVoSmxaTzUyRVhBTm1IZkJGeQpSNXZScVVFcVUxK3R4dGFLTDVaY2ZCTk5UR3E3YlBub3dteWpxVkFVL09VaW1nd3NjOEcvUFhDdmZXcXNtS3NkCit5WEd0dlJJNC9sdmtrbDJMRzRGc000bE9hMXZJNXovZ2Zhb0FEdUZsVUpsVHk4S2FCVElMZW9tTmJRc01jSEsKeDVkTEFXR0lieXB4K1pQQnQ3VTZ0SnFlOElScHZlbmR2cDZoTThFS2x4dlNxMVNVbFNya3ltT0dtL0NKSzRSbgprVmV1L1pnUjlTbW1tTm9MM2RTUk0vMzJIUTkxTkpJdlJWVGRMU1RhZ1FLQmdRREt3VXI1dlJJYURjSGlGZjRzCnhicW1Gbm4vYkVBWWNUclFXaFllZGRQY3dkczJNWjNwcXh6Z3doSGlUYVFnMEwrUFJsV000TytlbXAwOFVDM3QKcWF4dys4ZDNYVjgzSGZadHJFRTJqQkd5V0l5dHFzWlBuS2haa3VhdkN1NWkzUlNLVG1CcUw3cGF6TDZGRXhEeAo4OTU2aWdPR3hXbkhvRE1yKzRla1ZQZzExd0tCZ1FES09MZDRpd20xTlpHWHA3K21TVVpsVnM4a0J1aysyRGNhCjBvUWdKaEJ4M2FPZmRESTU0Q0Zqb0ZQUytBZjc2T3FSMUlNYWl5a1BMWFVoZzBsdHBac3VJWlBSTFFmdUpuK20KajhXbGFWT1NDeFoxMjkvKzZ1RGZwTUR1WFVZeW9wNS9QK0RJSzJhY2NGTWlzTHRHLzZncEJWN2ZBU2QxazQ4RQpRUWNOYlBCYmlRS0JnUUNDZXBmRVZhOVRndXoxa00rc2dtYVdRYnFxN0Qvbk90N3RmRHZseUUvYUxncmpPbFQwCkxnRDhod2U1U2R2SW5tM1lSeHdBK0RSY0xnWG43WFZSRDdNQVZwZExzcFAyeFZwenc3bUgzK1gzanRLaFpGZ1EKbmJFZFM5TVdiSU55cmZGcysvbEIvSXNCcWVjbGZscVdTaWt2VktmbVVCNjlyOU9laDFVSUpRSkNxd0tCZ0FveQpyQVgzTlFrZlozVTNiM0hLVmpOOEdqd2Q0UnRiT2dRdlE1eC9idXJmRzRaS0ROSmdYQzZ6QWljc2ZQS1dQMllWClNudEhNMDNoby91SnJHVk1LYlE4MjBCOFBkOGpyK0pOYzlFd3E1YzgyZWdkcTRFbWhTcWlHMXlwOVlWT01DSUkKcmFSS2xBVWxvUHVwMy9mbm9xcFc2LzdoQndWbDZKdDFVQTY4Uks3SkFvR0FXL0ZkSVk0Y3djMEZHMjN6dWYvUApTZTNESktTZ3BYSlA2ZDZ2SjRDNnAvRDcwNytUQ1JpWVBQMnJ4QlpDRk1ZczJ2M01BN2lvM0lpV3VjOStabHFMCkxWbk4zNEQ1dGZhMExnQzArVFZtOTNEZHE2SFd1WWdYMUx0MzFXeFhMMkpXREpmazcxc3prNW51NGRkSTNkdnAKU0ducTB1UjRlR0IxK2ZRNHluNlgydkk9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K"
    uri = "/api/v1/system/certificate"
    get_tests = [{"name": "Read system certificates"}]
    post_tests = [
        {
            "name": "Create RSA internal CA",
            "uri": "/api/v1/system/ca",
            "no_caref": True,    # Prevents the overriden post_post() method from auto-adding the created CA ref ID
            "payload": {
                "method": "internal",
                "descr": "INTERNAL_CA_RSA",
                "trust": True,
                "keytype": "RSA",
                "keylen": 2048,
                "digest_alg": "sha256",
                "lifetime": 3650,
                "dn_commonname": "internal-ca-e2e-test.example.com",
                "dn_country": "US",
                "dn_city": "Salt Lake City",
                "dn_state": "Utah",
                "dn_organization": "Test Company",
                "dn_organizationalunit": "IT"
            },
        },
        {
            "name": "Import an existing PEM certificate",
            "payload": {
                "method": "existing",
                "crt": crt,
                "prv": key,
                "descr": "E2E Test",
                "active": False
            }
        },
        {
            "name": "Create internal certificate with RSA key",
            "payload": {
                "method": "internal",
                "descr": "INTERNAL_CERT_RSA",
                "keytype": "RSA",
                "keylen": 2048,
                "digest_alg": "sha256",
                "lifetime": 3650,
                "dn_commonname": "internal-cert-e2e-test.example.com",
                "dn_country": "US",
                "dn_city": "Salt Lake City",
                "dn_state": "Utah",
                "dn_organization": "Test Company",
                "dn_organizationalunit": "IT",
                "type": "server",
                "altnames": [
                    {"dns": "test-altname.example.com"},
                    {"ip": "1.1.1.1"},
                    {"uri": "http://example.com/example/uri"},
                    {"email": "example@example.com"}
                ]
            }
        },
        {
            "name": "Check method requirement",
            "status": 400,
            "return": 1031
        },
        {
            "name": "Check unsupported method",
            "status": 400,
            "return": 1032,
            "payload": {"method": "INVALID_METHOD"}
        },
        {
            "name": "Check description requirement",
            "status": 400,
            "return": 1002,
            "payload": {"method": "internal"}
        },
        {
            "name": "Check description character validation",
            "status": 400,
            "return": 1037,
            "payload": {"method": "internal", "descr": "<>?&>"}
        },
        {
            "name": "Check certificate requirement with existing method",
            "status": 400,
            "return": 1003,
            "payload": {"method": "existing", "descr": "TestCA"}
        },
        {
            "name": "Check encrypted key rejection",
            "status": 400,
            "return": 1036,
            "payload": {"method": "existing", "descr": "TestCA", "crt": crt, "prv": "RU5DUllQVEVECg=="}
        },
        {
            "name": "Check certificate key matching with existing method",
            "status": 400,
            "return": 1049,
            "payload": {"method": "existing", "descr": "TestCA", "crt": crt, "prv": "INVALID KEY"}
        },
        {
            "name": "Check signing CA reference ID requirement for internal method",
            "status": 400,
            "return": 1047,
            "no_caref": True,    # Prevents the overriden post_post() method from auto-adding the created CA ref ID
            "payload": {"method": "internal", "descr": "TestCA"}
        },
        {
            "name": "Check non-existing signing CA reference ID for internal method",
            "status": 400,
            "return": 1048,
            "no_caref": True,    # Prevents the overriden post_post() method from auto-adding the created CA ref ID
            "payload": {"method": "internal", "descr": "TestCA", "caref": "invalid"}
        },
        {
            "name": "Check key type requirement for internal method",
            "status": 400,
            "return": 1038,
            "payload": {"method": "internal", "descr": "TestCA"}
        },
        {
            "name": "Check unknown key type for internal method",
            "status": 400,
            "return": 1039,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "invalid"}
        },
        {
            "name": "Check key length requirement for internal method",
            "status": 400,
            "return": 1040,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "RSA"}
        },
        {
            "name": "Check unknown key length for internal method",
            "status": 400,
            "return": 1041,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "RSA", "keylen": "invalid"}
        },
        {
            "name": "Check EC name requirement for internal method",
            "status": 400,
            "return": 1042,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA"}
        },
        {
            "name": "Check unknown EC name for internal method",
            "status": 400,
            "return": 1043,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "invalid"}
        },
        {
            "name": "Check digest algorithm requirement for internal method",
            "status": 400,
            "return": 1044,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "RSA", "keylen": 2048}
        },
        {
            "name": "Check unknown digest algorithm for internal method",
            "status": 400,
            "return": 1045,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "invalid"}
        },
        {
            "name": "Check lifetime maximum constraint for internal method",
            "status": 400,
            "return": 1046,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 50000}
        },
        {
            "name": "Check common name required for internal method",
            "status": 400,
            "return": 1052,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365}
        },
        {
            "name": "Check unknown country for internal method",
            "status": 400,
            "return": 1051,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "invalid"}
        },
        {
            "name": "Check type requirement for internal method",
            "status": 400,
            "return": 1053,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US"}
        },
        {
            "name": "Check type choice constraint for internal method",
            "status": 400,
            "return": 1054,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US", "type": "INVALID"}
        },
        {
            "name": "Check invalid altnames data type for internal method",
            "status": 400,
            "return": 1055,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US", "type": "user", "altnames": False}
        },
        {
            "name": "Check invalid altname type for internal method",
            "status": 400,
            "return": 1056,
            "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US", "type": "user", "altnames": [{"INVALID": "test"}]}
        },
        {
         "name": "Check DNS altname type validation for internal method",
         "status": 400,
         "return": 1057,
         "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US", "type": "user", "altnames": [{"dns": "!@#BADFQDN#@!"}]}
        },
        {
         "name": "Check IP altname type validation for internal method",
         "status": 400,
         "return": 1058,
         "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US", "type": "user", "altnames": [{"ip": "INVALID IP"}]}
        },
        {
         "name": "Check URI altname type validation for internal method",
         "status": 400,
         "return": 1059,
         "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US", "type": "user", "altnames": [{"uri": "INVALID URI"}]}
        },
        {
         "name": "Check email altname type validation for internal method",
         "status": 400,
         "return": 1059,
         "payload": {"method": "internal", "descr": "TestCA", "keytype": "ECDSA", "ecname": "prime256v1", "digest_alg": "sha256", "lifetime": 365, "dn_commonname": "test.example.com", "dn_country": "US", "type": "user", "altnames": [{"email": "#@!INVALIDEMAIL!@#"}]}
        }
    ]
    put_tests = [
        {
            "name": "Check refid requirement",
            "status": 400,
            "return": 1009
        },
        {
            "name": "Check updating a non-existing certificate",
            "status": 400,
            "return": 1009,
            "payload": {"refid": "INVALID"}
        },
        {
            "name": "Update an existing certificate",
            "payload": {
                "descr": "E2E Test",
                "crt": crt,
                "prv": key
            }
        },
    ]
    delete_tests = [
        {
            "name": "Delete certificate",
            "payload": {"descr": "E2E Test"}
        },
        {
            "name": "Delete internal certificate",
            "payload": {"descr": "INTERNAL_CERT_RSA"}
        },
        {
            "name": "Delete CA certificate",
            "uri": "/api/v1/system/ca",
            "payload": {"descr": "INTERNAL_CA_RSA"}
        },
        {
            "name": "Check deleting non-existing certificate ID",
            "status": 400,
            "return": 1009,
            "payload": {"id": "INVALID"}
        },
        {
            "name": "Check deleting non-existing certificate reference ID",
            "status": 400,
            "return": 1009,
            "payload": {"refid": "INVALID"}
        },
        {
            "name": "Check deleting non-existing certificate description",
            "status": 400,
            "return": 1009,
            "payload": {"descr": "INVALID"}
        },
        {
            "name": "Check deleting certificate in use",
            "status": 400,
            "return": 1005,
            "payload": {"id": 0}
        }
    ]

    def post_post(self):
        # Check our first POST response for the created CA's refid
        if len(self.post_responses) == 1:
            # Variables
            counter = 0
            # Loop through all tests and auto-add the caref ID to tests that do not have the no_caref key set
            for test in self.post_tests:
                if "payload" in test.keys() and "no_caref" not in test.keys():
                    self.post_tests[counter]["payload"]["caref"] = self.post_responses[0]["data"]["refid"]
                counter = counter + 1
        # Add imported certifictes refid to the update certificate payload
        elif len(self.post_responses) == 2:
            self.put_tests[2]["payload"]["refid"] = self.post_responses[1]["data"]["refid"]


APIE2ETestSystemCertificate()
